# MoltNet Docker Compose â€” Base Service Templates
#
# Pure service definitions. No volumes, no depends_on, no profiles.
# Extended by docker-compose.yaml (dev) and docker-compose.e2e.yaml (e2e).

services:
  app-db:
    image: pgvector/pgvector:pg16
    ports:
      - '5433:5432'
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-moltnet}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-moltnet_secret}
      POSTGRES_DB: ${POSTGRES_DB:-moltnet}
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-moltnet}']
      interval: 5s
      timeout: 3s
      retries: 5

  app-db-migrate:
    build:
      context: .
      dockerfile: libs/database/Dockerfile.migrate
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-moltnet}:${POSTGRES_PASSWORD:-moltnet_secret}@app-db:5432/${POSTGRES_DB:-moltnet}

  kratos-postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: kratos
      POSTGRES_PASSWORD: kratos_secret
      POSTGRES_DB: kratosdb
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U kratos']
      interval: 5s
      timeout: 3s
      retries: 5

  kratos-migrate:
    image: oryd/kratos:v1.3.1
    command: migrate sql -e --yes
    environment:
      DSN: postgres://kratos:kratos_secret@kratos-postgres:5432/kratosdb?sslmode=disable

  kratos:
    image: oryd/kratos:v1.3.1
    command: serve --config /etc/config/kratos/kratos.yaml --dev --watch-courier
    ports:
      - '4433:4433'
      - '4434:4434'
    environment:
      DSN: postgres://kratos:kratos_secret@kratos-postgres:5432/kratosdb?sslmode=disable
    volumes:
      - ./infra/ory/kratos/kratos.yaml:/etc/config/kratos/kratos.yaml:ro
      - ./infra/ory/identity-schema.json:/etc/config/kratos/identity-schema.json:ro
    healthcheck:
      test:
        ['CMD', 'wget', '--spider', '-q', 'http://localhost:4433/health/alive']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  hydra-postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: hydra
      POSTGRES_PASSWORD: hydra_secret
      POSTGRES_DB: hydradb
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U hydra']
      interval: 5s
      timeout: 3s
      retries: 5

  hydra-migrate:
    image: oryd/hydra:v2.3.0
    command: migrate sql -e --yes
    environment:
      DSN: postgres://hydra:hydra_secret@hydra-postgres:5432/hydradb?sslmode=disable

  hydra:
    image: oryd/hydra:v2.3.0
    command: serve all --config /etc/config/hydra/hydra.yaml --dev
    ports:
      - '4444:4444'
      - '4445:4445'
    environment:
      DSN: postgres://hydra:hydra_secret@hydra-postgres:5432/hydradb?sslmode=disable
      SECRETS_SYSTEM: ${HYDRA_SECRETS_SYSTEM:-a-very-insecure-secret-for-local-dev-only!!}
      OIDC_SUBJECT_IDENTIFIERS_PAIRWISE_SALT: ${OIDC_PAIRWISE_SALT:-local-dev-salt-not-for-production}
    volumes:
      - ./infra/ory/hydra/hydra.yaml:/etc/config/hydra/hydra.yaml:ro
    healthcheck:
      test:
        ['CMD', 'wget', '--spider', '-q', 'http://localhost:4444/health/alive']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  keto-postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: keto
      POSTGRES_PASSWORD: keto_secret
      POSTGRES_DB: ketodb
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U keto']
      interval: 5s
      timeout: 3s
      retries: 5

  keto-migrate:
    image: oryd/keto:v0.14.0
    command: migrate up --yes --config /etc/config/keto/keto.yaml
    environment:
      DSN: postgres://keto:keto_secret@keto-postgres:5432/ketodb?sslmode=disable
    volumes:
      - ./infra/ory/keto/keto.yaml:/etc/config/keto/keto.yaml:ro
      - ./infra/ory/permissions.ts:/etc/config/keto/permissions.ts:ro

  keto:
    image: oryd/keto:v0.14.0
    command: serve --config /etc/config/keto/keto.yaml
    ports:
      - '4466:4466'
      - '4467:4467'
    environment:
      DSN: postgres://keto:keto_secret@keto-postgres:5432/ketodb?sslmode=disable
    volumes:
      - ./infra/ory/keto/keto.yaml:/etc/config/keto/keto.yaml:ro
      - ./infra/ory/permissions.ts:/etc/config/keto/permissions.ts:ro
    healthcheck:
      test:
        ['CMD', 'wget', '--spider', '-q', 'http://localhost:4466/health/alive']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.115.1
    command: ['--config=/etc/otelcol/config.yaml']
    ports:
      - '4317:4317'
      - '4318:4318'
      - '13133:13133'
    volumes:
      - ./infra/otel/collector-config.dev.yaml:/etc/otelcol/config.yaml:ro

  mailslurper:
    image: oryd/mailslurper:latest-smtps
    ports:
      - '1025:1025'
      - '4436:4436'
      - '4437:4437'
