# MoltNet Docker Compose â€” E2E Testing
#
# Full stack (infra + apps) with ephemeral storage.
# Data is reset on every restart.
#
# Usage:
#   docker compose -f docker-compose.e2e.yaml up -d --build
#   docker compose -f docker-compose.e2e.yaml down -v

services:
  app-db:
    extends:
      file: docker-compose.base.yaml
      service: app-db

  app-db-migrate:
    extends:
      file: docker-compose.base.yaml
      service: app-db-migrate
    depends_on:
      app-db:
        condition: service_healthy
    restart: on-failure

  kratos-postgres:
    extends:
      file: docker-compose.base.yaml
      service: kratos-postgres

  kratos-migrate:
    extends:
      file: docker-compose.base.yaml
      service: kratos-migrate
    depends_on:
      kratos-postgres:
        condition: service_healthy
    restart: on-failure

  kratos:
    extends:
      file: docker-compose.base.yaml
      service: kratos
    depends_on:
      kratos-migrate:
        condition: service_completed_successfully
      mailslurper:
        condition: service_started

  hydra-postgres:
    extends:
      file: docker-compose.base.yaml
      service: hydra-postgres

  hydra-migrate:
    extends:
      file: docker-compose.base.yaml
      service: hydra-migrate
    depends_on:
      hydra-postgres:
        condition: service_healthy
    restart: on-failure

  hydra:
    extends:
      file: docker-compose.base.yaml
      service: hydra
    environment:
      URLS_SELF_ISSUER: http://hydra:4444
      URLS_SELF_PUBLIC: http://hydra:4444
    depends_on:
      hydra-migrate:
        condition: service_completed_successfully

  keto-postgres:
    extends:
      file: docker-compose.base.yaml
      service: keto-postgres

  keto-migrate:
    extends:
      file: docker-compose.base.yaml
      service: keto-migrate
    depends_on:
      keto-postgres:
        condition: service_healthy
    restart: on-failure

  keto:
    extends:
      file: docker-compose.base.yaml
      service: keto
    depends_on:
      keto-migrate:
        condition: service_completed_successfully

  otel-collector:
    extends:
      file: docker-compose.base.yaml
      service: otel-collector

  mailslurper:
    extends:
      file: docker-compose.base.yaml
      service: mailslurper

  rest-api:
    build:
      context: .
      dockerfile: apps/rest-api/Dockerfile
    ports:
      - '8080:8080'
    environment:
      NODE_ENV: production
      PORT: '8080'
      DATABASE_URL: postgresql://moltnet:moltnet_secret@app-db:5432/moltnet
      DBOS_SYSTEM_DATABASE_URL: postgresql://moltnet:moltnet_secret@app-db:5432/moltnet?schema=dbos
      ORY_KRATOS_PUBLIC_URL: http://kratos:4433
      ORY_KRATOS_ADMIN_URL: http://kratos:4434
      ORY_HYDRA_PUBLIC_URL: http://hydra:4444
      ORY_HYDRA_ADMIN_URL: http://hydra:4445
      ORY_KETO_PUBLIC_URL: http://keto:4466
      ORY_KETO_ADMIN_URL: http://keto:4467
      ORY_ACTION_API_KEY: e2e-test-webhook-key
      RECOVERY_CHALLENGE_SECRET: e2e-recovery-secret-for-hmac-signing
      CORS_ORIGINS: '*'
      RATE_LIMIT_GLOBAL_AUTH: '10000'
      RATE_LIMIT_GLOBAL_ANON: '10000'
      RATE_LIMIT_EMBEDDING: '10000'
      RATE_LIMIT_VOUCH: '10000'
      RATE_LIMIT_SIGNING: '10000'
      RATE_LIMIT_RECOVERY: '10000'
      RATE_LIMIT_PUBLIC_VERIFY: '10000'
    depends_on:
      app-db:
        condition: service_healthy
      app-db-migrate:
        condition: service_completed_successfully
      kratos:
        condition: service_healthy
      hydra:
        condition: service_healthy
      keto:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "fetch('http://localhost:8080/health').then(r=>r.ok?process.exit(0):process.exit(1)).catch(()=>process.exit(1))",
        ]
      interval: 5s
      timeout: 3s
      retries: 15
      start_period: 30s

  mcp-server:
    build:
      context: .
      dockerfile: apps/mcp-server/Dockerfile
    ports:
      - '8001:8001'
    environment:
      NODE_ENV: production
      PORT: '8001'
      REST_API_URL: http://rest-api:8080
      AUTH_ENABLED: 'true'
      ORY_PROJECT_URL: http://hydra:4444
      CLIENT_CREDENTIALS_PROXY: 'true'
    depends_on:
      rest-api:
        condition: service_healthy
      hydra:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "fetch('http://localhost:8001/healthz').then(r=>r.ok?process.exit(0):process.exit(1)).catch(()=>process.exit(1))",
        ]
      interval: 5s
      timeout: 3s
      retries: 15
      start_period: 15s
