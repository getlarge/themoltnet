name: Issue Triage

on:
  issues:
    types: [opened, edited, labeled]
  schedule:
    # Periodic sweep for issues updated outside standard events
    - cron: '0 */6 * * *'

permissions:
  contents: read
  issues: write
  pull-requests: read
  id-token: write

jobs:
  triage-single:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Triage issue
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            issues: write
          prompt: |
            You are the MoltNet issue triage agent. Review issue #${{ github.event.issue.number }}.

            Read the issue body and check these quality criteria:

            1. **Acceptance criteria**: The issue body contains a "Done when",
               "Acceptance criteria", or checklist section defining what "done" looks like.
            2. **Context files**: The issue body references specific files or directories
               in the repo (paths like `libs/auth/`, `apps/rest-api/src/`, etc.).
            3. **Dependencies declared**: The issue body explicitly lists dependencies
               (e.g., "Depends on #42") or states "No dependencies".
            4. **Single responsibility**: The issue describes one coherent task,
               not multiple unrelated changes.
            5. **Scoped effort**: The work is achievable in a single agent session
               (roughly 1-4 hours, not a multi-week epic).

            Evaluate each criterion as pass/fail with a brief explanation.

            **If ALL 5 pass:**
            ```bash
            gh issue edit ${{ github.event.issue.number }} --add-label "ready-for-agent"
            gh issue edit ${{ github.event.issue.number }} --remove-label "needs-spec"
            ```
            Comment: "Triage: all quality criteria pass. Ready for agent pickup."
            List which criteria passed.

            **If ANY fail:**
            ```bash
            gh issue edit ${{ github.event.issue.number }} --add-label "needs-spec"
            gh issue edit ${{ github.event.issue.number }} --remove-label "ready-for-agent"
            ```
            Comment: "Triage: this issue needs more detail."
            List which criteria failed and what's needed.

  triage-sweep:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Sweep issues needing re-triage
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            issues: write
          prompt: |
            You are the MoltNet issue triage agent running a periodic sweep.

            List open issues with the `needs-spec` label:
            ```bash
            gh issue list --state open --label "needs-spec" --limit 20 --json number,title,updatedAt
            ```

            For each, check if it was updated since the last triage comment.
            If it now meets all 5 quality criteria (acceptance criteria, context files,
            dependencies declared, single responsibility, scoped effort):
            - Remove `needs-spec`, add `ready-for-agent`
            - Comment noting it now passes

            Only re-check `needs-spec` issues. Skip `ready-for-agent` issues.
