name: Issue Triage

on:
  issues:
    types: [opened, edited, labeled]
  schedule:
    # Periodic sweep for issues updated outside standard events
    - cron: '0 */6 * * *'

permissions:
  contents: read
  issues: write
  pull-requests: read
  id-token: write

jobs:
  triage-single:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Triage issue
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: 'claude[bot]'
          additional_permissions: |
            issues: write
          claude_args: |
            --max-turns 6 --allowedTools "Bash(gh issue edit*),Bash(gh issue view*),Bash(gh issue comment*)"
          prompt: |
            Triage issue #${{ github.event.issue.number }}.

            Step 1: Fetch the issue (one call only):
            gh issue view ${{ github.event.issue.number }}

            Step 2: Evaluate these 5 quality criteria as pass/fail:
            1. Acceptance criteria — has "Done when", checklist, or acceptance criteria section
            2. Context files — references specific repo paths (e.g. `libs/auth/`, `apps/rest-api/src/`)
            3. Dependencies declared — lists deps (e.g. "Depends on #42") or states "No dependencies"
            4. Single responsibility — one coherent task, not multiple unrelated changes
            5. Scoped effort — achievable in one agent session (1-4 hours)

            Step 3: Apply labels and comment based on results.

            If ALL 5 pass, run these commands:
            gh issue edit ${{ github.event.issue.number }} --add-label "ready-for-agent" --remove-label "needs-spec"
            gh issue comment ${{ github.event.issue.number }} --body "Triage: all quality criteria pass. Ready for agent pickup. <criteria results>"

            If ANY fail, run these commands:
            gh issue edit ${{ github.event.issue.number }} --add-label "needs-spec" --remove-label "ready-for-agent"
            gh issue comment ${{ github.event.issue.number }} --body "Triage: this issue needs more detail. <criteria results with what's missing>"

  triage-sweep:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Sweep issues needing re-triage
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: 'claude[bot]'
          additional_permissions: |
            issues: write
          claude_args: |
            --max-turns 10 --allowedTools "Bash(gh issue list*),Bash(gh issue edit*),Bash(gh issue view*),Bash(gh issue comment*)"
          prompt: |
            Periodic sweep of issues needing re-triage.

            Step 1: List open issues with needs-spec label:
            gh issue list --state open --label "needs-spec" --limit 20 --json number,title,updatedAt

            Step 2: For each issue, run: gh issue view <number>
            Check if it now meets all 5 quality criteria:
            1. Acceptance criteria (has "Done when" / checklist)
            2. Context files (references repo paths)
            3. Dependencies declared
            4. Single responsibility
            5. Scoped effort (1-4 hours)

            Step 3: For issues that now pass all criteria:
            gh issue edit <number> --add-label "ready-for-agent" --remove-label "needs-spec"
            gh issue comment <number> --body "Re-triage: all criteria now pass. Ready for agent pickup."

            Skip issues that still fail criteria. Only re-check needs-spec issues.
