name: Mission Integrity

on:
  pull_request:
    branches: [main]

concurrency:
  group: mission-integrity-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Verify crypto library hasn't been swapped or tampered with
  crypto-integrity:
    name: Crypto Library Integrity
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile

      # Verify @noble/ed25519 package integrity via lockfile
      - name: Check @noble/ed25519 integrity
        run: |
          node << 'SCRIPT'
          const fs = require('fs');
          const lockfile = fs.readFileSync('./pnpm-lock.yaml', 'utf8');

          // pnpm-lock.yaml uses '@noble/ed25519@<version>': as package keys
          const versionMatch = lockfile.match(/'@noble\/ed25519@([\d.]+)':/);
          if (!versionMatch) {
            console.error('@noble/ed25519 not found in pnpm-lock.yaml');
            process.exit(1);
          }
          console.log('@noble/ed25519 version:', versionMatch[1]);

          // integrity hash follows the resolution block for that package
          const integrityMatch = lockfile.match(
            new RegExp("'@noble/ed25519@" + versionMatch[1].replace(/\./g, '\\.') + "':[\\s\\S]*?integrity:\\s+(sha\\S+)")
          );
          if (integrityMatch) {
            // Strip trailing comma if present
            const integrity = integrityMatch[1].replace(/,$/, '');
            console.log('integrity:', integrity);
          } else {
            console.error('No integrity hash found — lockfile may be corrupted');
            process.exit(1);
          }
          SCRIPT

      # Run frozen test vectors — these fail if the crypto implementation changes
      - name: Run Ed25519 test vectors
        run: pnpm --filter @moltnet/crypto-service test

  # Scan for new external service dependencies in the diff
  centralization-scan:
    name: Centralization Surface Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for new external URLs
        run: |
          echo "## Centralization Surface Scan" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          # Known/approved external service URLs
          KNOWN_URLS=(
            "themolt.net"
            "moltbook.com"
            "openclaw.com"
            "oryapis.com"
            "supabase.co"
            "fly.io"
            "github.com"
            "npmjs.org"
            "npmjs.com"
            "opentelemetry.io"
            "axiom.co"
            "claude.ai"
            "anthropic.com"
            "nodejs.org"
            "typescriptlang.org"
            "drizzle.team"
            "vitest.dev"
            "pnpm.io"
          )

          # Build grep exclusion pattern for known URLs
          EXCLUDE_PATTERN=$(printf "|%s" "${KNOWN_URLS[@]}")
          EXCLUDE_PATTERN="${EXCLUDE_PATTERN:1}"  # Remove leading |

          # Find new https:// URLs in the diff (excluding known ones)
          NEW_URLS=$(git diff "$BASE_SHA".."$HEAD_SHA" -- '*.ts' '*.json' '*.yml' '*.yaml' '*.md' \
            | grep -oP 'https?://[a-zA-Z0-9._/-]+' \
            | grep -vE "$EXCLUDE_PATTERN" \
            | sort -u || true)

          if [ -n "$NEW_URLS" ]; then
            echo "### New External URLs Detected" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "The following new external URLs were added in this PR." >> "$GITHUB_STEP_SUMMARY"
            echo "Verify these do not introduce unplanned external dependencies:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "$NEW_URLS" | while read -r url; do
              echo "- \`$url\`" >> "$GITHUB_STEP_SUMMARY"
            done
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "If these are intentional, add them to the known URLs list in \`.github/workflows/mission-integrity.yml\`." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No new external URLs detected." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Scan for new npm dependencies
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          # Check if any package.json files changed
          CHANGED_PKGS=$(git diff --name-only "$BASE_SHA".."$HEAD_SHA" -- '**/package.json' || true)

          if [ -n "$CHANGED_PKGS" ]; then
            echo "### Package Changes" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "The following package.json files were modified:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "$CHANGED_PKGS" | while read -r f; do
              echo "- \`$f\`" >> "$GITHUB_STEP_SUMMARY"
            done
            echo "" >> "$GITHUB_STEP_SUMMARY"

            # Show added dependencies (version strings or catalog: references)
            ADDED_DEPS=$(git diff "$BASE_SHA".."$HEAD_SHA" -- '**/package.json' \
              | grep -E '^\+.*"[^"]+"\s*:\s*"([\^~]?[0-9]|catalog:)' \
              | grep -v '^\+\+\+' || true)

            if [ -n "$ADDED_DEPS" ]; then
              echo "**New dependencies added:**" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              echo "$ADDED_DEPS" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "Review new dependencies for supply chain risk (see MISSION_INTEGRITY.md threat #9)." >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

      - name: Scan for auth/crypto changes
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          # Check if crypto or auth code changed
          CRYPTO_CHANGES=$(git diff --name-only "$BASE_SHA".."$HEAD_SHA" -- \
            'libs/crypto-service/**' 'libs/auth/**' '**/permissions.ts' \
            'infra/ory/**' || true)

          if [ -n "$CRYPTO_CHANGES" ]; then
            echo "### Trust Boundary Changes" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "These files affect the trust boundary (crypto, auth, permissions):" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "$CRYPTO_CHANGES" | while read -r f; do
              echo "- \`$f\`" >> "$GITHUB_STEP_SUMMARY"
            done
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Extra review required** — see MISSION_INTEGRITY.md decision framework." >> "$GITHUB_STEP_SUMMARY"
          fi

  # Verify PR body includes the mission integrity checklist
  pr-checklist:
    name: PR Checklist Validation
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Check mission integrity checklist
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            let summary = '## PR Checklist Validation\n\n';

            if (!body.trim()) {
              summary += 'PR body is empty. The mission integrity checklist is required.\n';
              summary += 'Use the PR template or add the checklist from docs/MISSION_INTEGRITY.md Part V.\n';
              await core.summary.addRaw(summary).write();
              core.setFailed('PR body is empty — mission integrity checklist required');
              return;
            }

            if (body.toLowerCase().includes('mission integrity')) {
              summary += 'Mission integrity checklist found in PR body.\n';
              await core.summary.addRaw(summary).write();
              core.info('Mission integrity checklist present');
            } else {
              summary += '**Warning**: Mission integrity checklist not found in PR body.\n\n';
              summary += 'Every PR should include the mission integrity checklist:\n\n';
              summary += '```\n';
              summary += '- [ ] Agent control: does NOT move control away from the agent\n';
              summary += '- [ ] Offline verifiable: can be verified without the server\n';
              summary += '- [ ] Platform survival: works if a managed service is replaced\n';
              summary += '- [ ] Simplicity: simplest solution that solves the problem\n';
              summary += '- [ ] Documented: architectural decisions are recorded\n';
              summary += '```\n';
              await core.summary.addRaw(summary).write();
              core.setFailed('Mission integrity checklist not found in PR body');
            }
