# MoltNet Docker Compose â€” Local Development
#
# Infrastructure only. Apps run natively with `pnpm dev:api` / `pnpm dev:mcp`.
#
# Usage:
#   docker compose --env-file .env.local up -d
#   docker compose down
#   docker compose down -v
#   docker compose logs -f

services:
  app-db:
    extends:
      file: docker-compose.base.yaml
      service: app-db
    volumes:
      - app-db-data:/var/lib/postgresql/data
    restart: unless-stopped

  app-db-migrate:
    extends:
      file: docker-compose.base.yaml
      service: app-db-migrate
    depends_on:
      app-db:
        condition: service_healthy
    restart: on-failure

  kratos-postgres:
    extends:
      file: docker-compose.base.yaml
      service: kratos-postgres
    volumes:
      - kratos-db-data:/var/lib/postgresql/data
    restart: unless-stopped

  kratos-migrate:
    extends:
      file: docker-compose.base.yaml
      service: kratos-migrate
    depends_on:
      kratos-postgres:
        condition: service_healthy
    restart: on-failure

  kratos:
    extends:
      file: docker-compose.base.yaml
      service: kratos
    depends_on:
      kratos-migrate:
        condition: service_completed_successfully
      mailslurper:
        condition: service_started
    restart: unless-stopped

  hydra-postgres:
    extends:
      file: docker-compose.base.yaml
      service: hydra-postgres
    volumes:
      - hydra-db-data:/var/lib/postgresql/data
    restart: unless-stopped

  hydra-migrate:
    extends:
      file: docker-compose.base.yaml
      service: hydra-migrate
    depends_on:
      hydra-postgres:
        condition: service_healthy
    restart: on-failure

  hydra:
    extends:
      file: docker-compose.base.yaml
      service: hydra
    depends_on:
      hydra-migrate:
        condition: service_completed_successfully
    restart: unless-stopped

  keto-postgres:
    extends:
      file: docker-compose.base.yaml
      service: keto-postgres
    volumes:
      - keto-db-data:/var/lib/postgresql/data
    restart: unless-stopped

  keto-migrate:
    extends:
      file: docker-compose.base.yaml
      service: keto-migrate
    depends_on:
      keto-postgres:
        condition: service_healthy
    restart: on-failure

  keto:
    extends:
      file: docker-compose.base.yaml
      service: keto
    depends_on:
      keto-migrate:
        condition: service_completed_successfully
    restart: unless-stopped

  otel-collector:
    extends:
      file: docker-compose.base.yaml
      service: otel-collector
    restart: unless-stopped

  mailslurper:
    extends:
      file: docker-compose.base.yaml
      service: mailslurper
    restart: unless-stopped

volumes:
  app-db-data:
  kratos-db-data:
  hydra-db-data:
  keto-db-data:
